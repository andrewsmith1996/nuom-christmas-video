<html>
  <head>
      <meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1.0, minimum-scale=1.0" />
    <style>
      body {
        padding: 0;
        margin:0;
      }

      #frame {
        width:100%;
        height:100%;
        position: relative;
        overflow: hidden;
      }

      video {
        position: absolute;
        transform-origin: top left;
        transform:scale(2);
        -webkit-transform-origin: top left;
        -webkit-transform:scale(2);
      }
    </style>

    <script>
      var host = location.origin.replace(/^http/, 'ws');
      var ws = new WebSocket(host);
      var state = {
        id:null,
        top:0,
        left:0,
        rotation:'0rad',
        scale:2,
        width: window.innerWidth,
        height: window.innerHeight
      };

      ws.onmessage = function (event) {
        var scale,
            scaleString,
            data = JSON.parse(event.data),
            videoElement = document.querySelector('video');

        if (data.newId) {
          state.id = data.newId;
        } else if ((data.deviceId == state.id || data.deviceId =='all') && data.changes) {
          if (data.changes.position) {
            state.top = videoElement.style.top = (data.changes.position.top * state.scale);
            state.left = videoElement.style.left = (data.changes.position.left * state.scale);
          }
          if (data.changes.rotation) {
//            Rotation is still broken so FUCK IT
//            var rotation = state.rotation = data.changes.rotation;
//            var parent = document.getElementById('video-container');
//            var originY = ( element.offsetTop + (state.height / 2)) + 'px';
//            var originX = ( element.offsetLeft + (state.width / 2)) + 'px';
//            parent.style.transformOrigin = [originX, originY, 0].join(' ');
//            parent.style.transform = 'rotate(' + rotation + ')';
//            parent.style.webkitTransformOrigin = [originX, originY, 0].join(' ');
//            parent.style.webkitTransform = 'rotate(' + rotation + ')';
          }
          if (data.changes.scale) {
            scale = data.changes.scale;
            scaleString = 'scale(' + scale + ')';
            videoElement.style.transform = scaleString;
            videoElement.style.webkitTransform = scaleString;
          }

        } else if (data == 'reset') {
          videoElement.currentTime = 0;
        } else if (data == 'pause') {
          videoElement.pause();
        } else if (data == 'resume') {
          videoElement.play();
        } else if (data.video) {
          videoElement.src = 'uploads/' + data.video;
          //reset video scale
          scale = 2;
          scaleString = 'scale(' + scale + ')';
          videoElement.style.transform = scaleString;
          videoElement.style.webkitTransform = scaleString;
        }
      };

      ws.onopen = function(event) {
        var videoElement = document.querySelector('video');
        send({initialValues:{height: state.height, width: state.width}});
        document.addEventListener('click', function(){ videoElement.play()} );
        videoElement.load();
      };

      function send(data) {
        ws.send(JSON.stringify(data))
      }
    </script>
  </head>
  <body>
    <div id="frame">
      <div id="video-container">
        <video muted autoplay loop></video>
      </div>
    </div>
  </body>
</html>
